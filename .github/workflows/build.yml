---
name: Build Configurations

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Generate AVD Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and AVD Collection
        run: |
          pip install ansible-core
          ansible-galaxy collection install arista.avd

      - name: Install AVD Python requirements
        run: |
          pip install -r ~/.ansible/collections/ansible_collections/arista/avd/requirements.txt

      - name: Create fabric configuration from secrets
        run: |
          cat > group_vars/DC-L3LS-FABRIC.yml << 'EOF'
          ---
          ### group_vars/FABRIC.yml

          # Ansible connectivity definitions
          ansible_connection: ansible.netcommon.httpapi
          ansible_network_os: arista.eos.eos
          ansible_user: ${{ secrets.ANSIBLE_USER || 'admin' }}
          ansible_password: ${{ secrets.ANSIBLE_PASSWORD || 'placeholder' }}
          ansible_become: true
          ansible_become_method: enable
          ansible_httpapi_use_ssl: true
          ansible_httpapi_validate_certs: false

          # Common AVD group variables
          fabric_name: DC-L3LS-FABRIC

          # Generate CSVs with fabric link info.
           eos_designs_documentation:
            topology_csv: true
            p2p_links_csv: true

          # Define underlay and overlay routing protocol to be used
          underlay_routing_protocol: ebgp
          overlay_routing_protocol: ebgp

          # BGP peer groups passwords
          bgp_peer_groups:
            evpn_overlay_peers:
              password: ${{ secrets.BGP_PASSWORD || 'placeholder' }}
            ipv4_underlay_peers:
              password: ${{ secrets.BGP_PASSWORD || 'placeholder' }}
            mlag_ipv4_underlay_peer:
              password: ${{ secrets.BGP_PASSWORD || 'placeholder' }}

          # P2P interfaces MTU
          p2p_uplinks_mtu: 1500

          # Define default interfaces
          default_interfaces:
            - types: [ spine ]
              platforms: [ cEOS ]
              uplink_interfaces: [ Ethernet1-2 ]
              downlink_interfaces: [ Ethernet1-8 ]
            - types: [ l3leaf ]
              platforms: [ cEOS ]
              uplink_interfaces: [ Ethernet1-2 ]
              mlag_interfaces: [ Ethernet49-50 ]
              downlink_interfaces: [ Ethernet1-8 ]
            - types: [ l3leaf ]
              platforms: [ cEOS ]
              uplink_interfaces: [ Ethernet1-2 ]
              mlag_interfaces: [ Ethernet49-50 ]
              downlink_interfaces: [ Ethernet8 ]

          # L3 Edge port definitions
          l3_edge:
            p2p_links_ip_pools:
              - name: DCI_IP_pool
                ipv4_pool: 172.16.100.0/24
            p2p_links_profiles:
              - name: DCI_profile
                ip_pool: DCI_IP_pool
                as: [65102, 65202]
                include_in_underlay_protocol: true
            p2p_links:
              - id: 1
                nodes: [dc01-bsl-01a, dc02-bsl-01a]
                interfaces: [Ethernet8, Ethernet8]
                profile: DCI_profile
              - id: 2
                nodes: [dc01-bsl-01a, dc02-bsl-01b]
                interfaces: [Ethernet9, Ethernet9]
                profile: DCI_profile
              - id: 3
                nodes: [dc01-bsl-01b, dc02-bsl-01b]
                interfaces: [Ethernet8, Ethernet8]
                profile: DCI_profile
              - id: 4
                nodes: [dc01-bsl-01b, dc02-bsl-01a]
                interfaces: [Ethernet9, Ethernet9]
                profile: DCI_profile
          EOF

      - name: Run AVD Build Playbook
        run: ansible-playbook build.yml

      - name: Upload generated configurations
        uses: actions/upload-artifact@v4
        with:
          name: avd-configurations
          path: |
            intended/
            documentation/
          retention-days: 30

      - name: Check for configuration changes
        if: github.event_name == 'pull_request'
        run: |
          echo "## Configuration Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully generated configurations for all devices" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Devices Configured:" >> $GITHUB_STEP_SUMMARY
          ls intended/configs/*.cfg | wc -l | xargs -I {} echo "- {} device configurations generated" >> $GITHUB_STEP_SUMMARY
